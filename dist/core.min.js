var Helpers;!function(t){var e=function(){function t(){}return t.prototype.isConnectedHelper=function(t){t||(window.location.href="/")},t.prototype.generateString=function(){return Math.random().toString(36).replace("0.","")},t.prototype.randomString=function(t,e){e=e||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";for(var n="",r=0;r<t;r++){var o=Math.floor(Math.random()*e.length);n+=e.substring(o,o+1)}return n},t.prototype.blurChat=function(){setTimeout(function(){document.getElementById("map").classList.add("blur")},500)},t.prototype.triggerInputKeypress=function(){var r=this;document.getElementById("chat_box").addEventListener("input",function(t){if(null!=typeof t.target){var e=140-r.countUtf8(t.target.value),n=document.getElementById("text_counter");n.innerHTML=e.toString(),n.style.color=e<10?"#d5243e":"#000000"}})},t.prototype.triggerEnterKey=function(){document.addEventListener("keypress",function(t){"Enter"===t.key&&document.getElementById("send_button").click()})},t.prototype.showChatContainer=function(){document.getElementById("chat_container").style.display="block"},t.prototype.activateHTML=function(){document.getElementById("chat_box").removeAttribute("disabled"),document.getElementById("send_button").removeAttribute("disabled"),this.blurChat(),this.showChatContainer(),this.triggerEnterKey(),this.triggerInputKeypress()},t.prototype.makeBubble=function(t,e){var n=document.createElement("div");"you"==t?n.setAttribute("class","col-12 text-right"):n.setAttribute("class","col-12 text-left"),document.getElementById("chat_container_box").appendChild(n);var r=document.createElement("div");return r.setAttribute("class","bubble-"+t+" "+t),n.appendChild(r),r.innerHTML=e,r},t.prototype.fixedCharCodeAt=function(t,e){e=e||0;var n,r,o=t.charCodeAt(e);if(55296<=o&&o<=56319){if(n=o,r=t.charCodeAt(e+1),isNaN(r))throw"Kein gültiges Schriftzeichen oder Speicherfehler!";return 1024*(n-55296)+(r-56320)+65536}return!(56320<=o&&o<=57343)&&o},t.prototype.countUtf8=function(t){for(var e=0,n=0;n<t.length;n++){var r=this.fixedCharCodeAt(t,n);"number"==typeof r&&(e+=r<128?1:r<2048?2:r<65536?3:r<2097152?4:r<67108864?5:6)}return e},t}();t.Helpers=e}(Helpers||(Helpers={}));
var Notify;!function(t){var i=function(){function t(){}return t.prototype.makeNotify=function(t,i,o,e){vNotify[t]({text:i,title:o,sticky:!1,position:e||"topRight",autoHide:!0,clickToHide:!0,autoHideDelay:3e3})},t}();t.Notify=i}(Notify||(Notify={}));
var Cords;!function(t){var e=function(){function t(){this.places=new Array,this.places.push({coords:{latitude:41.890062,longitude:12.492549}}),this.places.push({coords:{latitude:48.804541,longitude:2.12013}}),this.places.push({coords:{latitude:28.002726,longitude:86.852628}}),this.places.push({coords:{latitude:51.178882,longitude:-1.826226}}),this.places.push({coords:{latitude:38.897766,longitude:-77.036504}}),this.places.push({coords:{latitude:53.77995,longitude:20.49416}}),this.places.push({coords:{latitude:29.975715,longitude:31.137718}})}return t.prototype.getRandomPlace=function(){if(0<this.places.length){if(7!=this.places.length)return this.places[this.getRandomNumber(0,this.places.length-1)];var t=new Date;return this.places[t.getDay()]}throw new Error},t.prototype.getRandomNumber=function(t,e){return Math.floor(Math.random()*(e-t+1))+t},t}();t.Cords=e}(Cords||(Cords={}));
var Map;!function(t){var i=function(){function t(){this.token="pk.eyJ1IjoidG9jdzg2IiwiYSI6ImNqaHM0YTh2bzA3bDUzN254Mndyb2c4dm0ifQ.3eIb7F5PV-E6pBugRhs4cQ",this.cords=new Cords.Cords,this.defaultPosition=this.cords.getRandomPlace()}return t.prototype.getMap=function(){return this.map},t.prototype.getDefaultPosition=function(){return this.defaultPosition},t.prototype.initMap=function(){this.map=L.map("map").setView([this.defaultPosition.coords.latitude,this.defaultPosition.coords.longitude],14),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token="+this.token,{attribution:"",maxZoom:16,id:"mapbox.streets-satellite",accessToken:this.token}).addTo(this.map)},t.prototype.disableMap=function(){this.map.scrollWheelZoom.disable(),this.map.dragging.disable(),this.map.touchZoom.disable(),this.map.doubleClickZoom.disable(),this.map.boxZoom.disable(),this.map.keyboard.disable(),this.map.tap&&this.map.tap.disable(),this.map._handlers.forEach(function(t){t.disable()})},t}();t.Map=i}(Map||(Map={}));
var User;!function(t){var e=function(){function t(t,e,n){this.moving=!0,this.connected=!0,this.enabled=!0,this.user_id=t,this.enabled=!0,this.lat=e.coords.latitude,this.lng=e.coords.longitude,this.markerType=n}return t.prototype.setLng=function(t){this.lng=t},t.prototype.setLat=function(t){this.lat=t},t.prototype.getUserId=function(){return this.user_id},t.prototype.getJsonFromUser=function(){return JSON.stringify({lat:this.getLat(),lng:this.getLng(),user_id:this.getUserId(),markerType:this.getMarkerType(),enabled:!0})},t.prototype.isMoving=function(){return this.moving},t.prototype.stopMoving=function(){this.moving=!1},t.prototype.startMoving=function(){this.moving=!0},t.prototype.isConnected=function(){return this.connected},t.prototype.disconnect=function(){this.connected=!1},t.prototype.getMarker=function(){return this.marker},t.prototype.setEnable=function(){this.enabled=!0},t.prototype.disable=function(){this.enabled=!1},t.prototype.getMarkerType=function(){return this.markerType},t.prototype.setMarker=function(t){this.marker=t},t.prototype.getLat=function(){return this.lat},t.prototype.getLng=function(){return this.lng},t}();t.User=e}(User||(User={}));
var Comunicator;!function(t){var n=function(){function t(){}return t.prototype.setMyContext=function(t){this.myContext=t},t.prototype.setFriendContext=function(t){this.friendContext=t},t.prototype.setFriendId=function(t){this.friendId=t},t.prototype.setFriendPublicKey=function(t){this.friendPublicKey=t},t.prototype.getFriendContext=function(){return this.friendContext},t.prototype.getFriendPublicKey=function(){return this.friendPublicKey},t.prototype.getFriendId=function(){return this.friendId},t}();t.Comunicator=n}(Comunicator||(Comunicator={}));
var Init=function(){function e(e,t,n,r){var i=this;this.usersMarkers=[],this.icons={red:L.icon({iconUrl:"red-marker.svg",shadowUrl:"marker-shadow.png",iconSize:[25,41],iconAnchor:[0,20],shadowAnchor:[0,20]}),green:L.icon({iconUrl:"green-marker.svg",shadowUrl:"marker-shadow.png",iconSize:[25,41],iconAnchor:[0,20],shadowAnchor:[0,20]}),blue:L.icon({iconUrl:"blue-marker.svg",shadowUrl:"marker-shadow.png",iconSize:[25,41],iconAnchor:[0,20],shadowAnchor:[0,20]}),yellow:L.icon({iconUrl:"yellow-marker.svg",shadowUrl:"marker-shadow.png",iconSize:[25,41],iconAnchor:[0,20],shadowAnchor:[0,20]})},this.start=function(){i.run(i.map.getDefaultPosition())},this.run=function(e){i.sendUserData(),i.mapEvents(),i.setUserMarker(),i.windowEvents(),i.triggerSocketEvents()},this.sendUserData=function(){var e=i.user.getJsonFromUser();i.socket.emit("new_user",e)},this.markerFactory=function(e,t,n,r){var s=i,o=i.icons[r],a=L.marker([e,t],{icon:o}).addTo(i.map.getMap()).on("click",function(e){var t=this;setTimeout(function(){document.getElementById(n).addEventListener("click",function(e){s.startHandshake(n,t)})},50)});return a.bindPopup("<p>"+n+'<br/><button id="'+n+'">Handshake</button></p>'),a},this.startHandshake=function(e,t){if(i.user.isMoving()){i.communicator.setMyContext(i),i.communicator.setFriendContext(t);var n=t.getLatLng(),r=i.user.getMarker().getLatLng(),s=i.calculateDistance(r.lat,n.lat,r.lng,n.lng);s<3e3?(i.user.stopMoving(),i.communicator.setMyContext(i),i.communicator.setFriendContext(t),i.communicator.setFriendId(e),i.socket.emit("start_connect",JSON.stringify({to:e,from:i.user.getUserId(),gps:[[n.lat,n.lng],[r.lat,r.lng]],sender_pub_key:i.auth.getPublicKey()}))):alert("To far to make connection ("+s+" m). Min. distance 3000m")}},this.calculateDistance=function(e,t,n,r){var s=.017453292519943295,o=Math.cos,a=.5-o((e-t)*s)/2+o(t*s)*o(e*s)*(1-o((n-r)*s))/2,i=12742*Math.asin(Math.sqrt(a));return Math.round(1e3*i)},this.isConnected=function(){return!(!i.user.isConnected()||!i.socket.connected)||(i.user.isConnected()&&!i.socket.connected?(i.notify.makeNotify("error","Disconnected please refresh page","Error"),document.getElementById("status_notify").setAttribute("class","status_notify n_disconnect"),i.user.disconnect(),i.cleanAllMarkers(),i.map.disableMap(),i.disableUser(),i.changeStatusHtml(),!1):!(!i.user.isConnected()&&!i.socket.connected)&&void 0)},this.triggerSocketEvents=function(){var s=i;i.socket.on("draw_line",function(e){if(e){var t=s.communicator.getFriendContext().getLatLng(),n=s.user.getMarker().getLatLng();s.sender_line=L.polyline([[t.lat,t.lng],[n.lat,n.lng]],{color:"red",opacity:1,weight:2}).addTo(s.map.getMap())}}),i.socket.on("receive_message",function(e){var t=JSON.parse(e);if(t.hasOwnProperty("to")&&t.hasOwnProperty("encrypted")){var n=s.auth.decrypt_received(t.encrypted);s.helper.makeBubble("me",n).scrollIntoView()}}),i.socket.on("make_line",function(){document.getElementById("status_notify").setAttribute("class","status_notify n_connected"),s.sender_line.setStyle({color:"green"}),s.helper.activateHTML(),s.map.getMap().closePopup(),s.addSendButton(function(){var e=document.getElementById("chat_box").value;if(""!=e.trim()&&0<e.length&&s.helper.countUtf8(e)<=140){s.helper.isConnectedHelper(s.socket.isConnected());var t={encrypted:"",to:""};t.encrypted=s.auth.encrypt(e,s.communicator.getFriendPublicKey()),t.to=s.communicator.getFriendId(),s.socket.emit("send_message",JSON.stringify(t)),document.getElementById("chat_box").value=null,s.helper.makeBubble("you",e).scrollIntoView();document.getElementById("text_counter").innerHTML=140..toString()}})}),i.socket.on("save_friend_key",function(e){s.communicator.setFriendPublicKey(e),console.log("Zapisano klucz publiczny odbiorcy")}),i.socket.on("make_button_disconnect",function(){s.makeButtonDisconnect(function(){})}),i.socket.on("remove_line",function(){document.getElementById("status_notify").setAttribute("class","status_notify n_disconnect"),s.map.getMap().removeLayer(s.sender_line),s.user.setEnable(),s.user.startMoving()}),i.socket.on("handshake",function(e){var n=JSON.parse(e);if(n.to==s.user.getUserId()&&s.user.isMoving())return s.user.stopMoving(),confirm("Handshake from:"+n.from)?(s.user.disable(),s.communicator.setFriendPublicKey(n.sender_pub_key),s.communicator.setFriendId(n.from),console.log("Zapisano klucz publiczny nadawcy"),n.friend_pub_key=s.auth.getPublicKey(),s.socket.emit("handshake_success",JSON.stringify(n)),s.receiver_line=L.polyline(n.gps,{color:"green",opacity:1,weight:2}).addTo(s.map.getMap()),document.getElementById("status_notify").setAttribute("class","status_notify n_connected"),s.helper.activateHTML(),s.makeButtonDisconnect(function(){}),s.addSendButton(function(){var e=document.getElementById("chat_box").value;if(""!=e.trim()&&0<e.length&&s.helper.countUtf8(e)<=140){var t={encrypted:s.auth.encrypt(e,s.communicator.getFriendPublicKey()),to:n.from};s.socket.emit("send_message",JSON.stringify(t)),document.getElementById("chat_box").value=null,s.helper.makeBubble("you",e).scrollIntoView();document.getElementById("text_counter").innerHTML=140..toString()}}),!0):(s.user.startMoving(),s.user.setEnable(),s.socket.emit("handshake_failed",e),s.notify.makeNotify("error","Private Room","Refused invitation"),document.getElementById("status_notify").setAttribute("class","status_notify n_disconnect"),!1)}),i.socket.on("load_users",function(e){for(var t=JSON.parse(e),n=0;n<t.length;n++)if(t[n].user_id!=s.user.getUserId()&&t[n].enabled){var r=s.markerFactory(t[n].lat,t[n].lng,t[n].user_id,t[n].markerType);s.usersMarkers.push({user_id:t[n].user_id,marker:r,enabled:t[n].enabled})}}),i.socket.on("load_user",function(e){var t=JSON.parse(e);if(t.user_id!=s.user.getUserId()){var n=s.markerFactory(t.lat,t.lng,t.user_id,t.markerType);s.usersMarkers.push({user_id:t.user_id,marker:n,enabled:t.enabled})}}),i.socket.on("move_marker",function(e){for(var t=JSON.parse(e),n=0;n<s.usersMarkers.length;n++)t.user_id==s.usersMarkers[n].user_id&&s.usersMarkers[n].marker.setLatLng({lat:t.lat,lng:t.lng})}),i.socket.on("remove_marker",function(e){for(var t=0;t<s.usersMarkers.length;t++)e==s.usersMarkers[t].user_id&&s.usersMarkers[t].marker.remove()})},this.cleanAllMarkers=function(){for(var e=0;e<i.usersMarkers.length;e++)i.usersMarkers[e].marker.remove();i.user.getMarker().remove()},this.disableUser=function(){i.user.disable(),i.user.stopMoving()},this.changeStatusHtml=function(){document.getElementById("status_toolbar").innerHTML='  <i class="fas fa-ban danger"></i>&nbsp;disconnected'},this.addSendButton=function(e){document.getElementById("send_button").addEventListener("click",function(){e()})},this.setUserMarker=function(){var e=i.icons[i.user.getMarkerType()];i.user.setMarker(L.marker([i.user.getLat(),i.user.getLng()],{icon:e}).addTo(i.map.getMap()))},this.mapEvents=function(){var t=i;i.map.getMap().on("click",function(e){t.isConnected(),void 0!==t.user.getMarker()&&t.user.isMoving()&&t.isConnected()&&(t.user.setLat(e.latlng.lat),t.user.setLng(e.latlng.lng),t.user.getMarker().setLatLng(e.latlng),t.updateUserData())})},this.updateUserData=function(){i.socket.emit("update_user",i.user.getJsonFromUser())},this.helper=new Helpers.Helpers,this.socket=e,this.communicator=new Comunicator.Comunicator,this.notify=new Notify.Notify,this.map=new Map.Map,this.map.initMap(),this.user=new User.User(e.id,this.map.getDefaultPosition(),t),this.auth=new n(e.id,r)}return e.prototype.windowEvents=function(){window.addEventListener("beforeunload",function(e){})},e.prototype.makeButtonDisconnect=function(e){},e}();
$(window).on("load",function(){var o=io;io=null;var t=new Worker("worker.js");t.addEventListener("message",function(t){var n=t.data;console.log("SSH key generated!"),document.getElementById("progress_info").innerHTML="Wybierz swój marker",document.getElementById("markers").style.opacity=1;var s=auth;auth=void 0,$(".col-6").click(function(){var t=$(this).data("marker");if(null!=t&&""!=t&&-1<["red","green","blue","yellow"].indexOf(t)){var e=o.connect("/",{secure:!0,rejectUnauthorized:!1});e.on("console",function(t){t?document.getElementById("status_notify").setAttribute("class","status_notify n_success"):document.getElementById("status_notify").setAttribute("class","status_notify n_disconnect")}),e.on("connect",function(){new Init(e,t,s,n).start(),$("#map").show(),$("#main-container").hide()})}else document.getElementById("status_notify").setAttribute("class","status_notify n_disconnect")})},!1),t.postMessage("sad")});