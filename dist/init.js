var Init=function(){function e(e,t,n){var s=this;this.moving=!0,this.usersMarkers=[],this.icons={red:L.icon({iconUrl:"marker-icon-red.png",shadowUrl:"marker-shadow.png"}),green:L.icon({iconUrl:"marker-icon-green.png",shadowUrl:"marker-shadow.png"}),blue:L.icon({iconUrl:"marker-icon.png",shadowUrl:"marker-shadow.png"})},this.enabled=!0,this.connected=!0,this.start=function(){s.run(s.map.getDefaultPosition())},this.run=function(e){s.setUserDate(e),s.sendUserData(),s.auth=new s.auth(s.user_id),s.mapEvents(),s.setUserMarker(),s.windowEvents(),s.triggerSocketEvents()},this.setUserDate=function(e){s.lat=e.coords.latitude,s.lng=e.coords.longitude,s.user_id=s.socket.id,s.enabled=!0},this.getJsonFromUser=function(){return JSON.stringify({lat:s.lat,lng:s.lng,user_id:s.user_id,markerType:s.markerType,enabled:s.enabled})},this.sendUserData=function(){s.socket.emit("new_user",s.getJsonFromUser())},this.markerFactory=function(e,t,n,r){var o=s,a=s.icons[r],i=L.marker([e,t],{icon:a}).addTo(s.map.getMap()).on("click",function(e){var t=this;setTimeout(function(){document.getElementById(n).addEventListener("click",function(e){o.startHandshake(n,t)})},50)});return i.bindPopup("<p>"+n+'<br/><button id="'+n+'">Handshake</button></p>'),i},this.startHandshake=function(e,t){if(s.moving){s.communicator.setMyContext(s),s.communicator.setFriendContext(t);var n=t.getLatLng(),r=s.marker.getLatLng(),o=s.calculateDistance(r.lat,n.lat,r.lng,n.lng);o<3e3?(s.moving=!1,s.communicator.setMyContext(s),s.communicator.setFriendContext(t),s.communicator.setFriendId(e),s.socket.emit("start_connect",JSON.stringify({to:e,from:s.user_id,gps:[[n.lat,n.lng],[r.lat,r.lng]],sender_pub_key:s.auth.getPublicKey()}))):alert("To far to make connection ("+o+" m). Min. distance 3000m")}},this.calculateDistance=function(e,t,n,r){var o=.017453292519943295,a=Math.cos,i=.5-a((e-t)*o)/2+a(t*o)*a(e*o)*(1-a((n-r)*o))/2,s=12742*Math.asin(Math.sqrt(i));return Math.round(1e3*s)},this.isConnected=function(){return!(!s.connected||!s.socket.connected)||(s.connected&&!s.socket.connected?(s.notify.makeNotify("error","Disconnected please refresh page","Error"),s.connected=!1,s.cleanAllMarkers(),s.map.disableMap(),s.disableUser(),s.changeStatusHtml(),!1):!(!s.connected&&!s.socket.connected)&&void 0)},this.triggerSocketEvents=function(){var o=s;s.socket.on("draw_line",function(e){if(e){var t=o.communicator.getFriendContext().getLatLng(),n=o.marker.getLatLng();o.sender_line=L.polyline([[t.lat,t.lng],[n.lat,n.lng]],{color:"red",opacity:1,weight:2}).addTo(o.map.getMap())}}),s.socket.on("receive_message",function(e){var t=JSON.parse(e);if(t.hasOwnProperty("to")&&t.hasOwnProperty("encrypted")){var n=o.auth.decrypt_received(t.encrypted);o.notify.makeNotify("success",n,"New message"),alert(n)}}),s.socket.on("make_line",function(){o.notify.makeNotify("info","Private Room","Connected to user"),o.sender_line.setStyle({color:"green"}),o.map.getMap().closePopup(),o.addSendButton(function(){var e=document.getElementById("chat_box").value,t={encrypted:"",to:""};t.encrypted=o.auth.encrypt(e,o.communicator.getFriendPublicKey()),t.to=o.communicator.getFriendId(),o.socket.emit("send_message",JSON.stringify(t))})}),s.socket.on("save_friend_key",function(e){o.communicator.setFriendPublicKey(e),console.log("Zapisano klucz publiczny odbiorcy")}),s.socket.on("make_button_disconnect",function(){o.makeButtonDisconnect(function(){})}),s.socket.on("remove_line",function(){o.notify.makeNotify("error","Private Room","Friend refuse invitation"),o.map.getMap().removeLayer(o.sender_line),o.enabled=!0,o.moving=!0}),s.socket.on("handshake",function(e){var n=JSON.parse(e);if(n.to==o.user_id&&o.moving)return o.moving=!1,confirm("Handshake from:"+n.from)?(o.enabled=!1,o.communicator.setFriendPublicKey(n.sender_pub_key),console.log("Zapisano klucz publiczny nadawcy"),n.friend_pub_key=o.auth.getPublicKey(),o.socket.emit("handshake_success",JSON.stringify(n)),o.receiver_line=L.polyline(n.gps,{color:"green",opacity:1,weight:2}).addTo(o.map.getMap()),o.notify.makeNotify("info","Private Room","Connected to user"),o.makeButtonDisconnect(function(){}),o.addSendButton(function(){var e=document.getElementById("chat_box").value,t={encrypted:o.auth.encrypt(e,o.communicator.getFriendPublicKey()),to:n.from};o.socket.emit("send_message",JSON.stringify(t))}),!0):(o.moving=!0,o.enabled=!0,o.socket.emit("handshake_failed",e),o.notify.makeNotify("error","Private Room","Refused invitation"),!1)}),s.socket.on("load_users",function(e){for(var t=JSON.parse(e),n=0;n<t.length;n++)if(t[n].user_id!=o.user_id&&t[n].enabled){var r=o.markerFactory(t[n].lat,t[n].lng,t[n].user_id,t[n].markerType);o.usersMarkers.push({user_id:t[n].user_id,marker:r,enabled:t[n].enabled})}}),s.socket.on("load_user",function(e){var t=JSON.parse(e);if(t.user_id!=o.user_id){var n=o.markerFactory(t.lat,t.lng,t.user_id,t.markerType);o.usersMarkers.push({user_id:t.user_id,marker:n,enabled:t.enabled})}}),s.socket.on("move_marker",function(e){for(var t=JSON.parse(e),n=0;n<o.usersMarkers.length;n++)t.user_id==o.usersMarkers[n].user_id&&o.usersMarkers[n].marker.setLatLng({lat:t.lat,lng:t.lng})}),s.socket.on("remove_marker",function(e){for(var t=0;t<o.usersMarkers.length;t++)e==o.usersMarkers[t].user_id&&o.usersMarkers[t].marker.remove()})},this.cleanAllMarkers=function(){for(var e=0;e<s.usersMarkers.length;e++)s.usersMarkers[e].marker.remove();s.marker.remove()},this.disableUser=function(){s.enabled=!1,s.moving=!1},this.changeStatusHtml=function(){document.getElementById("status_toolbar").innerHTML='  <i class="fas fa-ban danger"></i>&nbsp;disconnected'},this.addSendButton=function(e){var t=document.createElement("button");t.id="send_button",t.style.width="100px",t.style.height="100px",t.innerHTML="Send",document.getElementById("console").appendChild(t),t.addEventListener("click",function(){e()})},this.setUserMarker=function(){var e=s.icons[s.markerType];s.marker=L.marker([s.lat,s.lng],{icon:e}).addTo(s.map.getMap())},this.mapEvents=function(){var t=s;s.map.getMap().on("click",function(e){t.isConnected(),void 0!==t.marker&&t.moving&&t.isConnected()&&(t.lat=e.latlng.lat,t.lng=e.latlng.lng,t.marker.setLatLng(e.latlng),t.updateUserData())})},this.updateUserData=function(){s.socket.emit("update_user",s.getJsonFromUser())},this.auth=n,this.socket=e,this.markerType=t,this.communicator=new Comunicator.Comunicator,this.notify=new Notify.Notify,this.map=new Map.Map}return e.prototype.windowEvents=function(){window.addEventListener("beforeunload",function(e){})},e.prototype.randomString=function(e,t){t=t||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";for(var n="",r=0;r<e;r++){var o=Math.floor(Math.random()*t.length);n+=t.substring(o,o+1)}return n},e.prototype.makeButtonDisconnect=function(e){var t=document.createElement("div");t.setAttribute("class","d-b"),document.getElementById("console").appendChild(t);var n=document.createElement("button");n.innerHTML="Disconnect",t.appendChild(n),n.addEventListener("click",function(){window.location.href="/"})},e}();