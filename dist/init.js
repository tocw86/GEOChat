var Init=function(){function r(r,e){var a=this;this.token="pk.eyJ1IjoidG9jdzg2IiwiYSI6ImNqaHM0YTh2bzA3bDUzN254Mndyb2c4dm0ifQ.3eIb7F5PV-E6pBugRhs4cQ",this.usersMarkers=[],this.icons={red:L.icon({iconUrl:"marker-icon-red.png",shadowUrl:"marker-shadow.png"}),green:L.icon({iconUrl:"marker-icon-green.png",shadowUrl:"marker-shadow.png"}),blue:L.icon({iconUrl:"marker-icon.png",shadowUrl:"marker-shadow.png"})},this.defaultPosition={coords:{latitude:37.629562,longitude:-116.849556}},this.error=function(){a.run(a.defaultPosition)},this.run=function(r){a.setUserDate(r),a.sendUserData(),a.windowEvents(),a.initMap(),a.setUserMarker(),a.mapEvents(),a.triggerSocketEvents()},this.setUserDate=function(r){a.lat=r.coords.latitude,a.lng=r.coords.longitude,a.user_id=a.randomString(32)},this.getJsonFromUser=function(){return JSON.stringify({lat:a.lat,lng:a.lng,user_id:a.user_id,markerType:a.markerType})},this.sendUserData=function(){a.socket.emit("new_user",a.getJsonFromUser())},this.markerFactory=function(r,e,t,n){var s=a.icons[n],o=L.marker([r,e],{icon:s}).addTo(a.map).on("click",function(r){console.log(this.getLatLng())});return o.bindPopup("<p>"+t+'<br/><button id="'+t+'">Handshake</button></p>'),o},this.triggerSocketEvents=function(){var s=a;a.socket.on("load_users",function(r){for(var e=JSON.parse(r),t=0;t<e.length;t++)if(e[t].user_id!=s.user_id){var n=s.markerFactory(e[t].lat,e[t].lng,e[t].user_id,e[t].markerType);s.usersMarkers.push({user_id:e[t].user_id,marker:n})}}),a.socket.on("load_user",function(r){var e=JSON.parse(r);if(e.user_id!=s.user_id){var t=s.markerFactory(e.lat,e.lng,e.user_id,e.markerType);s.usersMarkers.push({user_id:e.user_id,marker:t})}}),a.socket.on("move_marker",function(r){for(var e=JSON.parse(r),t=0;t<s.usersMarkers.length;t++)e.user_id==s.usersMarkers[t].user_id&&s.usersMarkers[t].marker.setLatLng({lat:e.lat,lng:e.lng})}),a.socket.on("remove_marker",function(r){for(var e=0;e<s.usersMarkers.length;e++)r==s.usersMarkers[e].user_id&&s.usersMarkers[e].marker.remove()})},this.initMap=function(){a.map=L.map("map").setView([a.lat,a.lng],14),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token="+a.token,{attribution:"",maxZoom:16,id:"mapbox.streets-satellite",accessToken:a.token}).addTo(a.map)},this.setUserMarker=function(){var r=a.icons[a.markerType];a.marker=L.marker([a.lat,a.lng],{icon:r}).addTo(a.map)},this.mapEvents=function(){var e=a;a.map.on("click",function(r){void 0!==e.marker&&(e.lat=r.latlng.lat,e.lng=r.latlng.lng,e.marker.setLatLng(r.latlng),e.updateUserData())})},this.updateUserData=function(){a.socket.emit("update_user",a.getJsonFromUser())},this.socket=r,this.markerType=e,navigator.geolocation?navigator.geolocation.getCurrentPosition(this.run,this.error):alert("Geolocation is not supported by this browser.")}return r.prototype.windowEvents=function(){window.addEventListener("beforeunload",function(r){})},r.prototype.randomString=function(r,e){e=e||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";for(var t="",n=0;n<r;n++){var s=Math.floor(Math.random()*e.length);t+=e.substring(s,s+1)}return t},r}();