var Init=function(){function r(r,e){var i=this;this.moving=!0,this.token="pk.eyJ1IjoidG9jdzg2IiwiYSI6ImNqaHM0YTh2bzA3bDUzN254Mndyb2c4dm0ifQ.3eIb7F5PV-E6pBugRhs4cQ",this.usersMarkers=[],this.icons={red:L.icon({iconUrl:"marker-icon-red.png",shadowUrl:"marker-shadow.png"}),green:L.icon({iconUrl:"marker-icon-green.png",shadowUrl:"marker-shadow.png"}),blue:L.icon({iconUrl:"marker-icon.png",shadowUrl:"marker-shadow.png"})},this.defaultPosition={coords:{latitude:37.629562,longitude:-116.849556}},this.error=function(){i.run(i.defaultPosition)},this.run=function(r){i.setUserDate(r),i.sendUserData(),i.windowEvents(),i.initMap(),i.setUserMarker(),i.mapEvents(),i.triggerSocketEvents()},this.setUserDate=function(r){i.lat=r.coords.latitude,i.lng=r.coords.longitude,i.user_id=i.randomString(32)},this.getJsonFromUser=function(){return JSON.stringify({lat:i.lat,lng:i.lng,user_id:i.user_id,markerType:i.markerType})},this.sendUserData=function(){i.socket.emit("new_user",i.getJsonFromUser())},this.markerFactory=function(r,e,t,n){var a=i,o=i.icons[n],s=L.marker([r,e],{icon:o}).addTo(i.map).on("click",function(r){var e=this;setTimeout(function(){document.getElementById(t).addEventListener("click",function(r){a.startHandshake(t,e)})},50)});return s.bindPopup("<p>"+t+'<br/><button id="'+t+'">Handshake</button></p>'),s},this.startHandshake=function(r,e){i.moving=!1;var t=e.getLatLng(),n=i.marker.getLatLng();L.polyline([[t.lat,t.lng],[n.lat,n.lng]],{color:"red",opacity:.6,weight:2}).addTo(i.map);i.socket.emit("start_connect",JSON.stringify({to:r,from:i.user_id}))},this.triggerSocketEvents=function(){var a=i;i.socket.on("handshake",function(r){var e=JSON.parse(r);e.to==a.user_id&&(a.moving=!1,alert("Handshake from:"+e.from))}),i.socket.on("load_users",function(r){for(var e=JSON.parse(r),t=0;t<e.length;t++)if(e[t].user_id!=a.user_id){var n=a.markerFactory(e[t].lat,e[t].lng,e[t].user_id,e[t].markerType);a.usersMarkers.push({user_id:e[t].user_id,marker:n})}}),i.socket.on("load_user",function(r){var e=JSON.parse(r);if(e.user_id!=a.user_id){var t=a.markerFactory(e.lat,e.lng,e.user_id,e.markerType);a.usersMarkers.push({user_id:e.user_id,marker:t})}}),i.socket.on("move_marker",function(r){for(var e=JSON.parse(r),t=0;t<a.usersMarkers.length;t++)e.user_id==a.usersMarkers[t].user_id&&a.usersMarkers[t].marker.setLatLng({lat:e.lat,lng:e.lng})}),i.socket.on("remove_marker",function(r){for(var e=0;e<a.usersMarkers.length;e++)r==a.usersMarkers[e].user_id&&a.usersMarkers[e].marker.remove()})},this.initMap=function(){i.map=L.map("map").setView([i.lat,i.lng],14),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token="+i.token,{attribution:"",maxZoom:16,id:"mapbox.streets-satellite",accessToken:i.token}).addTo(i.map)},this.setUserMarker=function(){var r=i.icons[i.markerType];i.marker=L.marker([i.lat,i.lng],{icon:r}).addTo(i.map)},this.mapEvents=function(){var e=i;i.map.on("click",function(r){void 0!==e.marker&&e.moving&&(e.lat=r.latlng.lat,e.lng=r.latlng.lng,e.marker.setLatLng(r.latlng),e.updateUserData())})},this.updateUserData=function(){i.socket.emit("update_user",i.getJsonFromUser())},this.socket=r,this.markerType=e,navigator.geolocation?navigator.geolocation.getCurrentPosition(this.run,this.error):alert("Geolocation is not supported by this browser.")}return r.prototype.windowEvents=function(){window.addEventListener("beforeunload",function(r){})},r.prototype.randomString=function(r,e){e=e||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";for(var t="",n=0;n<r;n++){var a=Math.floor(Math.random()*e.length);t+=e.substring(a,a+1)}return t},r}();